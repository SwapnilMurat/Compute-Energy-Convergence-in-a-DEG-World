import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Play, Zap, Cloud, Database, Activity, DollarSign, Leaf } from 'lucide-react';

const DEGBecknSystem = () => {
  const [isRunning, setIsRunning] = useState(false);
  const [becknLogs, setBecknLogs] = useState([]);
  const [metrics, setMetrics] = useState(null);
  const [workloadData, setWorkloadData] = useState([]);
  
  const runBecknWorkflow = async () => {
    setIsRunning(true);
    setBecknLogs([]);
    
    const logs = [];
    const addLog = (step, action, status, details) => {
      const log = {
        timestamp: new Date().toISOString(),
        step,
        action,
        status,
        details
      };
      logs.push(log);
      setBecknLogs([...logs]);
    };
    
    await new Promise(r => setTimeout(r, 500));
    addLog(1, 'SEARCH', 'SUCCESS', 'Grid Agent searching for compute slots with renewable energy');
    
    await new Promise(r => setTimeout(r, 400));
    addLog(2, 'ON_SEARCH', 'SUCCESS', 'Compute Provider responds with catalog: 250 AI training slots, 180 inference slots available');
    
    await new Promise(r => setTimeout(r, 500));
    addLog(3, 'SELECT', 'SUCCESS', 'Selected 120 inference slots during high solar generation window (11:00-15:00)');
    
    await new Promise(r => setTimeout(r, 400));
    addLog(4, 'ON_SELECT', 'SUCCESS', 'Quote received: £0.042/inference, Carbon: 180g CO2/kWh, P415 VLP eligible');
    
    await new Promise(r => setTimeout(r, 500));
    addLog(5, 'INIT', 'SUCCESS', 'Initialized order with carbon cap 250g CO2/kWh, deferral window 30min');
    
    await new Promise(r => setTimeout(r, 400));
    addLog(6, 'ON_INIT', 'SUCCESS', 'Final quote: £4.98 total, Est. carbon savings: 12.4 kg CO2');
    
    await new Promise(r => setTimeout(r, 500));
    addLog(7, 'CONFIRM', 'SUCCESS', 'Order confirmed: OBP ID=OBP-2025-DEG-4832, P444 settlement traceable');
    
    await new Promise(r => setTimeout(r, 400));
    addLog(8, 'ON_CONFIRM', 'SUCCESS', 'Workload scheduled: Region=EU-West-Solar, Start=11:15, End=14:45');
    
    await new Promise(r => setTimeout(r, 800));
    addLog(9, 'STATUS', 'SUCCESS', 'Workload 45% complete, Renewable usage: 94%, Grid carbon: 165g CO2/kWh');
    
    await new Promise(r => setTimeout(r, 800));
    addLog(10, 'STATUS', 'SUCCESS', 'Workload 100% complete, Cost: £4.89 (saved £1.32), Carbon saved: 15.2 kg CO2');
    
    Workload execution data
    const workloadResults = [];
    for (let i = 0; i < 24; i++) {
      const solarPower = Math.max(0, Math.sin((i - 6) * Math.PI / 12) * 120);
      const windPower = 40 + Math.sin(i * Math.PI / 8) * 25;
      const totalRenewable = solarPower + windPower;
      
      const carbonIntensity = totalRenewable > 80 ? 180 : 420;
      const computeAllocated = totalRenewable > 60 ? Math.min(totalRenewable * 0.8, 100) : 20;
      const costPerInference = totalRenewable > 80 ? 0.038 : 0.065;
      
      workloadResults.push({
        hour: i,
        solar: solarPower,
        wind: windPower,
        totalRenewable,
        computeAllocated,
        carbonIntensity,
        costPerInference: costPerInference * 1000, // in pence for visibility
      });
    }
    
    setWorkloadData(workloadResults);
    
    const totalCompute = workloadResults.reduce((sum, h) => sum + h.computeAllocated, 0);
    const avgCarbon = workloadResults.reduce((sum, h) => sum + h.carbonIntensity * h.computeAllocated, 0) / totalCompute;
    const totalCost = workloadResults.reduce((sum, h) => sum + h.costPerInference * h.computeAllocated / 1000, 0);
    const baselineCost = totalCompute * 0.065;
    const carbonSaved = (420 - avgCarbon) * totalCompute / 1000;
    
    setMetrics({
      totalInferences: Math.floor(totalCompute * 100),
      costPerInference: (totalCost / totalCompute).toFixed(3),
      totalCost: totalCost.toFixed(2),
      costSaved: (baselineCost - totalCost).toFixed(2),
      avgCarbon: avgCarbon.toFixed(0),
      carbonSaved: carbonSaved.toFixed(1),
      renewableUsage: 87.3,
      p415Revenue: (totalCompute * 0.012).toFixed(2)
    });
    
    setIsRunning(false);
  };

  return (
    <div className="w-full max-w-7xl mx-auto p-6 bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen">
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-white mb-2 flex items-center gap-3">
          <Zap className="text-yellow-400" size={40} />
          Compute-Energy Convergence with Beckn Protocol
        </h1>
        <p className="text-slate-300 text-lg">
          Agentic Orchestration for DEG-Powered Data Centers
        </p>
      </div>

      {/* Control Panel */}
      <Card className="mb-6 bg-slate-800 border-slate-700">
        <CardHeader>
          <CardTitle className="text-white flex items-center gap-2">
            <Cloud className="text-blue-400" />
            Beckn Protocol Orchestration
          </CardTitle>
        </CardHeader>
        <CardContent>
          <button
            onClick={runBecknWorkflow}
            disabled={isRunning}
            className="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
          >
            <Play size={20} />
            {isRunning ? 'Executing Workflow...' : 'Run Beckn Discovery → Confirm Flow'}
          </button>
        </CardContent>
      </Card>

      {/* Beckn Transaction Log */}
      {becknLogs.length > 0 && (
        <Card className="mb-6 bg-slate-800 border-slate-700">
          <CardHeader>
            <CardTitle className="text-white flex items-center gap-2">
              <Activity className="text-green-400" />
              Beckn Protocol Transaction Log
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {becknLogs.map((log, idx) => (
                <div key={idx} className="flex items-start gap-3 bg-slate-700 p-3 rounded text-sm">
                  <span className="text-blue-400 font-mono min-w-[60px]">Step {log.step}</span>
                  <span className={`font-semibold min-w-[120px] ${
                    log.action.startsWith('ON_') ? 'text-green-400' : 'text-yellow-400'
                  }`}>
                    {log.action}
                  </span>
                  <span className="text-emerald-400 min-w-[80px]">{log.status}</span>
                  <span className="text-slate-300 flex-1">{log.details}</span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Performance Metrics */}
      {metrics && (
        <>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <Card className="bg-gradient-to-br from-blue-900 to-blue-800 border-blue-700">
              <CardContent className="p-4">
                <div className="flex items-center gap-2 mb-2">
                  <DollarSign className="text-yellow-400" size={24} />
                  <div className="text-xs text-blue-200">Cost per Inference</div>
                </div>
                <div className="text-3xl font-bold text-white">£{metrics.costPerInference}</div>
                <div className="text-sm text-green-400 mt-1">Saved £{metrics.costSaved}</div>
              </CardContent>
            </Card>

            <Card className="bg-gradient-to-br from-green-900 to-green-800 border-green-700">
              <CardContent className="p-4">
                <div className="flex items-center gap-2 mb-2">
                  <Leaf className="text-emerald-400" size={24} />
                  <div className="text-xs text-green-200">Carbon Intensity</div>
                </div>
                <div className="text-3xl font-bold text-white">{metrics.avgCarbon}</div>
                <div className="text-sm text-green-400 mt-1">g CO₂/kWh</div>
              </CardContent>
            </Card>

            <Card className="bg-gradient-to-br from-purple-900 to-purple-800 border-purple-700">
              <CardContent className="p-4">
                <div className="flex items-center gap-2 mb-2">
                  <Zap className="text-yellow-400" size={24} />
                  <div className="text-xs text-purple-200">Renewable Usage</div>
                </div>
                <div className="text-3xl font-bold text-white">{metrics.renewableUsage}%</div>
                <div className="text-sm text-purple-300 mt-1">{metrics.totalInferences} inferences</div>
              </CardContent>
            </Card>

            <Card className="bg-gradient-to-br from-orange-900 to-orange-800 border-orange-700">
              <CardContent className="p-4">
                <div className="flex items-center gap-2 mb-2">
                  <DollarSign className="text-yellow-400" size={24} />
                  <div className="text-xs text-orange-200">P415 Flexibility</div>
                </div>
                <div className="text-3xl font-bold text-white">£{metrics.p415Revenue}</div>
                <div className="text-sm text-orange-300 mt-1">VLP revenue earned</div>
              </CardContent>
            </Card>
          </div>

          {/* Workload Allocation Chart */}
          <Card className="mb-6 bg-slate-800 border-slate-700">
            <CardHeader>
              <CardTitle className="text-white">24-Hour Compute Allocation & Energy Sources</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={350}>
                <LineChart data={workloadData}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#475569" />
                  <XAxis dataKey="hour" stroke="#94a3b8" label={{ value: 'Hour of Day', position: 'insideBottom', offset: -5, fill: '#94a3b8' }} />
                  <YAxis stroke="#94a3b8" />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #475569' }}
                    labelStyle={{ color: '#f1f5f9' }}
                  />
                  <Legend />
                  <Line type="monotone" dataKey="solar" stroke="#fbbf24" name="Solar (kW)" strokeWidth={2} />
                  <Line type="monotone" dataKey="wind" stroke="#06b6d4" name="Wind (kW)" strokeWidth={2} />
                  <Line type="monotone" dataKey="computeAllocated" stroke="#10b981" name="Compute Allocated (kW)" strokeWidth={3} />
                </LineChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          {/* Carbon & Cost Optimization */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card className="bg-slate-800 border-slate-700">
              <CardHeader>
                <CardTitle className="text-white">Carbon Intensity by Hour</CardTitle>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={250}>
                  <BarChart data={workloadData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#475569" />
                    <XAxis dataKey="hour" stroke="#94a3b8" />
                    <YAxis stroke="#94a3b8" />
                    <Tooltip 
                      contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #475569' }}
                      labelStyle={{ color: '#f1f5f9' }}
                    />
                    <Bar dataKey="carbonIntensity" fill="#ef4444" name="Carbon (g CO₂/kWh)" />
                  </BarChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>

            <Card className="bg-slate-800 border-slate-700">
              <CardHeader>
                <CardTitle className="text-white">Cost per Inference (pence)</CardTitle>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={250}>
                  <BarChart data={workloadData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#475569" />
                    <XAxis dataKey="hour" stroke="#94a3b8" />
                    <YAxis stroke="#94a3b8" />
                    <Tooltip 
                      contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #475569' }}
                      labelStyle={{ color: '#f1f5f9' }}
                    />
                    <Bar dataKey="costPerInference" fill="#3b82f6" name="Cost (pence)" />
                  </BarChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>
          </div>
        </>
      )}

      {/* Architecture Overview */}
      <Card className="mt-6 bg-slate-800 border-slate-700">
        <CardHeader>
          <CardTitle className="text-white flex items-center gap-2">
            <Database className="text-purple-400" />
            Beckn Protocol Implementation
          </CardTitle>
        </CardHeader>
        <CardContent className="text-slate-300 space-y-4">
          <div>
            <h3 className="font-semibold text-white mb-2">Agent Roles:</h3>
            <ul className="text-sm space-y-1 list-disc list-inside">
              <li><strong>Grid BAP (Buyer):</strong> Energy network operator searching for flexible compute capacity</li>
              <li><strong>Compute BPP (Provider):</strong> Data center publishing compute slots as catalog items</li>
              <li><strong>Storage BPP:</strong> Battery systems offering discharge capacity during peak demand</li>
              <li><strong>Beckn Gateway:</strong> Routes discovery requests across the DEG network</li>
            </ul>
          </div>
          <div>
            <h3 className="font-semibold text-white mb-2">API Workflow:</h3>
            <p className="text-sm">
              <span className="text-yellow-400">SEARCH</span> → <span className="text-green-400">ON_SEARCH</span> (catalog) → 
              <span className="text-yellow-400"> SELECT</span> → <span className="text-green-400">ON_SELECT</span> (quote) → 
              <span className="text-yellow-400"> INIT</span> → <span className="text-green-400">ON_INIT</span> (terms) → 
              <span className="text-yellow-400"> CONFIRM</span> → <span className="text-green-400">ON_CONFIRM</span> (OBP ID) → 
              <span className="text-yellow-400"> STATUS</span> (tracking)
            </p>
          </div>
          <div>
            <h3 className="font-semibold text-white mb-2">Key Features:</h3>
            <ul className="text-sm list-disc list-inside space-y-1">
              <li>Asynchronous server-to-server communication (no client blocking)</li>
              <li>OBP ID tracking for P444 settlement verification</li>
              <li>P415 VLP activation for demand flexibility monetization</li>
              <li>Carbon intensity cap enforcement (250g CO₂/kWh)</li>
              <li>Workload deferral windows (15-60 min) for grid balancing</li>
            </ul>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default DEGBecknSystem;
